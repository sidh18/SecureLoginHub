<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Superadmin Dashboard</title>
    <!--
      This <style> block is copied directly from your admin-dashboard.html
      to ensure a consistent look and feel.
    -->
    <style th:fragment="aef-admin-styles">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        body.modal-open {
            overflow: hidden;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 40px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 24px;
        }

        .navbar-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .navbar-tenant-name {
            font-size: 20px;
            font-weight: 300;
            color: #e0e0e0;
            border-left: 2px solid #a38cd1;
            padding-left: 15px;
        }

        .navbar-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            background: #f0f0f0;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-header h2 {
            color: #333;
            font-size: 22px;
        }

        .card-header-buttons {
            display: flex;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-primary {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-superadmin {
            background: #e2d1f1;
            color: #560c60;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-buttons button {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Modal Styles (Identical to admin-dashboard) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
            overflow-y: auto;
            padding: 5vh 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 0 auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div class="navbar">
    <div class="navbar-title">
        <h1>üëë Superadmin Dashboard</h1>
    </div>
    <div class="navbar-right">
        <span>Welcome, <strong th:text="${adminUsername}"></strong></span>
        <!-- Removed User View button -->
        <form th:action="@{/logout}" method="post" style="margin: 0;">
            <button type="submit" class="btn btn-danger">Logout</button>
        </form>
    </div>
</div>

<div class="container">
    <!-- Global Statistics -->
    <div class="stats">
        <div class="stat-card">
            <h3 id="totalOrganizations">0</h3>
            <p>Total Organizations</p>
        </div>
        <div class="stat-card">
            <h3 id="totalUsers">0</h3>
            <p>Total Users (All Orgs)</p>
        </div>
        <div class="stat-card">
            <h3 id="totalAdmins">0</h3>
            <p>Total Tenant Admins</p>
        </div>
<!--        <div class="stat-card">-->
<!--            <h3 id="totalSsoConfigs">0</h3>-->
<!--            <p>Total SSO Configs</p>-->
<!--        </div>-->
        <div class="stat-card">
            <h3 id="totalOpenBugs" style="color: #dc3545;">0</h3>
            <p>Open Bug Reports</p>
        </div>
    </div>

    <!-- Organization Management -->
    <div class="card">
        <div class="card-header">
            <h2>üè¢ Organization Management</h2>
            <button class="btn btn-success" onclick="openCreateOrgModal()">+ Create Organization</button>
        </div>

        <table id="organizationsTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Subdomain</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="organizationsTableBody">
            <!-- Dynamic content -->
            </tbody>
        </table>
    </div>

    <!-- Global User Management -->
    <div class="card">
        <div class="card-header">
            <h2 id="userListTitle">üë• Global User Management</h2>
            <div class="card-header-buttons">
                <button class="btn btn-secondary" onclick="showAllUsers()">Show All Users</button>
                <button class="btn btn-success" onclick="openCreateUserModal()">+ Create Global User</button>
            </div>
        </div>

        <table id="usersTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Organization</th> <!-- NEW COLUMN -->
                <th>Role</th>
                <th>Status</th>
                <th>Created Via</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="usersTableBody">
            <!-- Dynamic content -->
            </tbody>
        </table>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>üêû Bug Reports</h2>
            <button class="btn btn-primary" onclick="loadBugReports()">Refresh List</button>
        </div>

        <table id="bugReportsTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Organization</th>
                <th>Reported By</th>
                <th>Description</th>
                <th>Reported At</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="bugReportsTableBody">
            </tbody>
        </table>
    </div>

    <!-- Global SSO Configuration (Read-Only) -->
<!--    <div class="card">-->
<!--        <div class="card-header">-->
<!--            <h2>üîê Global SSO Configurations (Read-Only)</h2>-->
<!--        </div>-->

<!--        <table id="ssoConfigsTable">-->
<!--            <thead>-->
<!--            <tr>-->
<!--                <th>ID</th>-->
<!--                <th>Name</th>-->
<!--                <th>Organization</th> &lt;!&ndash; NEW COLUMN &ndash;&gt;-->
<!--                <th>Type</th>-->
<!--                <th>Status</th>-->
<!--            </tr>-->
<!--            </thead>-->
<!--            <tbody id="ssoConfigsTableBody">-->
<!--            &lt;!&ndash; Dynamic content &ndash;&gt;-->
<!--            </tbody>-->
<!--        </table>-->
<!--    </div>-->
</div>

<!-- MODALS -->

<!-- 1. Create Organization Modal -->
<div id="organizationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Organization</h3>
            <button class="close" onclick="closeModal('organizationModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Organization Name *</label>
                <input type="text" id="orgName" placeholder="e.g., Acme Inc.">
            </div>
            <div class="form-group">
                <label>Subdomain *</label>
                <input type="text" id="orgSubdomain" placeholder="e.g., acme">
                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                    Users will log in at <strong id="subdomainPreview">acme</strong>.sidhkocheta.cloud
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('organizationModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveOrganization()">Save Organization</button>
        </div>
    </div>
</div>

<!-- 2. Create Tenant Admin Modal -->
<div id="tenantAdminModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="tenantAdminModalTitle">Create Tenant Admin</h3>
            <button class="close" onclick="closeModal('tenantAdminModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="tenantAdminOrgId">
            <div class="form-group">
                <label>Username *</label>
                <input type="text" id="tenantAdminUsername" placeholder="e.g., acme-admin">
            </div>
            <div class="form-group">
                <label>Password *</label>
                <input type="password" id="tenantAdminPassword" placeholder="Enter temporary password">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="tenantAdminEmail" placeholder="admin@acme.com">
            </div>
            <div class="form-group">
                <label>First Name</label>
                <input type="text" id="tenantAdminFirstName" placeholder="Admin">
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="tenantAdminLastName" placeholder="User">
            </div>
            <p style="font-size: 12px; color: #666;">This user will be created with <span class="badge badge-primary">ROLE_ADMIN</span>.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('tenantAdminModal')">Cancel</button>
            <button class="btn btn-success" onclick="createTenantAdmin()">Create Admin User</button>
        </div>
    </div>
</div>

<!-- 3. Create/Edit Global User Modal (Modified from admin-dashboard) -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="userModalTitle">Create New User</h3>
            <button class="close" onclick="closeModal('userModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="userId">
            <div class="form-group">
                <label>Username *</label>
                <input type="text" id="userUsername" placeholder="Enter username">
            </div>
            <div class="form-group" id="passwordGroup">
                <label>Password</label>
                <input type="password" id="userPassword" placeholder="Enter password (required for new users)">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="userEmail" placeholder="Enter email">
            </div>
            <div class="form-group">
                <label>First Name</label>
                <input type="text" id="userFirstName" placeholder="Enter first name">
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="userLastName" placeholder="Enter last name">
            </div>
            <div class="form-group">
                <label>Role *</label>
                <select id="userRole" onchange="toggleOrganizationDropdown(this.value)">
                    <!-- Superadmin can create all roles -->
                    <option value="ROLE_USER">User</option>
                    <option value="ROLE_ADMIN">Tenant Admin</option>
                    <option value="ROLE_SUPER_ADMIN">Superadmin</option>
                </select>
            </div>
            <!-- NEW: Organization dropdown -->
            <div class="form-group" id="userOrganizationGroup">
                <label>Organization *</label>
                <select id="userOrganizationId">
                    <!-- Options will be populated by JavaScript -->
                    <option value="">None (Superadmin)</option>
                </select>
                <p style="font-size: 12px; color: #666; margin-top: 5px;" id="userOrgHelpText">
                    Users and Tenant Admins must belong to an organization.
                </p>
            </div>

            <div class="form-group">
                <label>Status</label>
                <select id="userActive">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveUser()">Save User</button>
        </div>
    </div>
</div>

<!--
    --- FIX: Read the JWT token from the model into a JS variable ---
-->
<script th:inline="javascript">
    /*<![CDATA[*/
    const JWT_TOKEN = /*[[${jwtToken}]]*/ null;
    /*]]>*/

    // --- Global Base URL for API ---
    // All calls will be to /superadmin/api/...
    const API_BASE = '/superadmin/api';

    // --- Global API Headers ---
    // This header will be added to every fetch request
    const API_HEADERS = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${JWT_TOKEN}`
    };

</script>

<script>
    // --- Load All Data on Page Load ---
    document.addEventListener('DOMContentLoaded', function() {
        if (!JWT_TOKEN) {
            console.error('FATAL: JWT_TOKEN is missing. API calls will fail.');
            // Do not alert here, as it's annoying. Console log is enough.
        }

        loadStats();
        loadOrganizations();
        loadGlobalUsers();
        loadGlobalSsoConfigs();
        loadBugReports();

        // Add listener to subdomain input for preview
        const subdomainInput = document.getElementById('orgSubdomain');
        if(subdomainInput) {
            subdomainInput.addEventListener('keyup', function() {
                document.getElementById('subdomainPreview').textContent = this.value || 'subdomain';
            });
        }
    });

    // --- 1. Load Global Statistics ---
    async function loadStats() {
        try {
            const response = await fetch(`${API_BASE}/stats`, { headers: API_HEADERS }); // <-- ADD HEADERS
            if (!response.ok) throw new Error('Failed to fetch stats');
            const stats = await response.json();

            document.getElementById('totalOrganizations').textContent = stats.totalOrganizations || 0;
            document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
            // Note: Your AdminService.getGlobalStats needs to return these keys
            document.getElementById('totalAdmins').textContent = stats.totalAdmins || 0;
            document.getElementById('totalSsoConfigs').textContent = stats.totalSsoConfigs || 0;

        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    // --- 2. Load Organizations Table & User Modal Dropdown ---
    async function loadOrganizations() {
        try {
            const response = await fetch(`${API_BASE}/organizations`, { headers: API_HEADERS }); // <-- ADD HEADERS
            if (!response.ok) throw new Error('Failed to fetch organizations');
            const organizations = await response.json();

            const tbody = document.getElementById('organizationsTableBody');
            const userOrgDropdown = document.getElementById('userOrganizationId');

            tbody.innerHTML = ''; // Clear table
            // Clear dropdown but keep the "None" option
            userOrgDropdown.innerHTML = '<option value="">None (Superadmin)</option>';

            if (organizations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">ü§∑</div>No organizations found. Click "Create" to add one.</td></tr>';
                return;
            }

            // Update stats
            // We subtract 1 if 'superadmin' org exists, as it's internal
            const tenantOrgs = organizations.filter(org => org.subdomain !== 'superadmin');
            document.getElementById('totalOrganizations').textContent = tenantOrgs.length;

            organizations.forEach(org => {
                // Add to table
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${org.id}</td>
                    <td><strong>${org.name}</strong></td>
                    <td><a href="http://${org.subdomain}.sidhkocheta.cloud" target="_blank">${org.subdomain}</a></td>
                    <td>${org.createdAt ? new Date(org.createdAt).toLocaleDateString() : '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="openTenantAdminModal(${org.id}, '${org.name}')" ${org.subdomain === 'superadmin' ? 'disabled' : ''}>Create Admin</button>
                            <button class="btn btn-primary" onclick="filterUsersByOrg(${org.id}, '${org.name}')">View Users</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);

                // Add to user modal dropdown
                // Exclude the 'superadmin' org from the dropdown
                if (org.subdomain !== 'superadmin') {
                    const option = document.createElement('option');
                    option.value = org.id;
                    option.textContent = `${org.name} (ID: ${org.id})`;
                    userOrgDropdown.appendChild(option);
                }
            });
        } catch (error) {
            console.error('Error loading organizations:', error);
            const tbody = document.getElementById('organizationsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state" style="color: #721c24;">Failed to load organizations.</td></tr>';
        }
    }

    // --- 3. Load Global Users Table (Filterable) ---
    async function loadGlobalUsers(organizationId = null) {
        let url = `${API_BASE}/users`;
        if (organizationId) {
            url += `?orgId=${organizationId}`;
        }

        try {
            const response = await fetch(url, { headers: API_HEADERS }); // <-- ADD HEADERS
            if (!response.ok) throw new Error('Failed to fetch users');
            const users = await response.json();

            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            // Update stats
            if (!organizationId) { // Only update global stats if not filtering
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalAdmins').textContent = users.filter(u => u.role === 'ROLE_ADMIN').length;
            }


            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">ü§∑</div>No users found.</td></tr>';
                return;
            }

            users.forEach(user => {
                const tr = document.createElement('tr');
                let roleBadge = 'badge-success'; // ROLE_USER
                if (user.role === 'ROLE_ADMIN') roleBadge = 'badge-primary';
                if (user.role === 'ROLE_SUPER_ADMIN') roleBadge = 'badge-superadmin';

                // --- THIS IS THE FIX ---
                // The backend serializes a field called "organizationName" from the getOrganizationName() method.
                // We will use that field directly.
                let orgName = user.organizationName ? user.organizationName : '<em>N/A (Superadmin)</em>';

                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td><strong>${user.username}</strong></td>
                    <td>${orgName}</td>
                    <td><span class="badge ${roleBadge}">${user.role.replace('ROLE_', '')}</span></td>
                    <td><span class="badge ${user.active ? 'badge-success' : 'badge-danger'}">${user.active ? 'Active' : 'Inactive'}</span></td>
                    <td><span class="badge ${user.createdVia === 'SSO' ? 'badge-warning' : 'badge-primary'}">${user.createdVia || 'REGULAR'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="editUser(${user.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id}, '${user.username}')">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading users:', error);
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state" style="color: #721c24;">Failed to load users.</td></tr>';
        }
    }

    // --- 4. Load Global SSO Configs (Read-Only) ---
    async function loadGlobalSsoConfigs() {
        try {
            const response = await fetch(`${API_BASE}/sso-configs`, { headers: API_HEADERS }); // <-- ADD HEADERS
            if (!response.ok) throw new Error('Failed to fetch SSO configs');
            const configs = await response.json();

            const tbody = document.getElementById('ssoConfigsTableBody');
            tbody.innerHTML = '';

            if (configs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">üö´</div>No SSO configurations found across all tenants.</td></tr>';
                return;
            }

            // Update stats count
            document.getElementById('totalSsoConfigs').textContent = configs.length;

            configs.forEach(config => {
                const tr = document.createElement('tr');
                // --- THIS IS THE FIX ---
                // We need to apply the same fix here for SSO configs.
                // Your SsoConfig.java will also need a getOrganizationName() helper.
                // For now, let's assume it has one, or that SsoConfig.organization is serialized.
                let orgName = config.organizationName || (config.organization ? config.organization.name : '<em>N/A (Global)</em>');

                tr.innerHTML = `
                <td>${config.id}</td>
                <td><strong>${config.name}</strong></td>
                <td>${orgName}</td>
                <td><span class="badge badge-primary">${config.ssoType}</span></td>
                <td><span class="badge ${config.enabled ? 'badge-success' : 'badge-danger'}">${config.enabled ? 'Enabled' : 'Disabled'}</span></td>
            `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading SSO configs:', error);
            const tbody = document.getElementById('ssoConfigsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state" style="color: #721c24;">Failed to load SSO configs.</td></tr>';
        }
    }

    // --- 5. User Table Filter Functions ---
    function filterUsersByOrg(orgId, orgName) {
        document.getElementById('userListTitle').textContent = `Users for: ${orgName}`;
        loadGlobalUsers(orgId);
    }

    function showAllUsers() {
        document.getElementById('userListTitle').textContent = 'Global User Management';
        loadGlobalUsers(null);
    }

    // --- 6. Modal Open/Close Functions ---
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
        document.body.classList.add('modal-open');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        document.body.classList.remove('modal-open');
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            closeModal('organizationModal');
            closeModal('tenantAdminModal');
            closeModal('bugReportModal');
            closeModal('userModal');
        }
    }

    // --- 7. Organization CRUD ---
    function openCreateOrgModal() {
        document.getElementById('orgName').value = '';
        document.getElementById('orgSubdomain').value = '';
        document.getElementById('subdomainPreview').textContent = 'subdomain';
        openModal('organizationModal');
    }

    async function saveOrganization() {
        const name = document.getElementById('orgName').value;
        const subdomain = document.getElementById('orgSubdomain').value;

        if (!name || !subdomain) {
            alert('Name and Subdomain are required.');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/organizations`, {
                method: 'POST',
                headers: API_HEADERS, // <-- ADD HEADERS
                body: JSON.stringify({ name: name, subdomain: subdomain })
            });

            if (response.ok) {
                closeModal('organizationModal');
                loadOrganizations(); // Refresh org table and user dropdown
            } else {
                const error = await response.json();
                alert('Failed to save organization: ' + (error.error || 'Subdomain may be taken.'));
            }
        } catch (error) {
            console.error('Error saving organization:', error);
            alert('Error saving organization.');
        }
    }

    // --- 8. Tenant Admin Creation ---
    function openTenantAdminModal(orgId, orgName) {
        document.getElementById('tenantAdminModalTitle').textContent = `Create Admin for: ${orgName}`;
        document.getElementById('tenantAdminOrgId').value = orgId;
        document.getElementById('tenantAdminUsername').value = '';
        document.getElementById('tenantAdminPassword').value = '';
        document.getElementById('tenantAdminEmail').value = '';
        document.getElementById('tenantAdminFirstName').value = '';
        document.getElementById('tenantAdminLastName').value = '';
        openModal('tenantAdminModal');
    }

    async function createTenantAdmin() {
        const organizationId = document.getElementById('tenantAdminOrgId').value;
        const username = document.getElementById('tenantAdminUsername').value;
        const password = document.getElementById('tenantAdminPassword').value;
        const email = document.getElementById('tenantAdminEmail').value;
        const firstName = document.getElementById('tenantAdminFirstName').value;
        const lastName = document.getElementById('tenantAdminLastName').value;

        if (!organizationId || !username || !password) {
            alert('Username and Password are required.');
            return;
        }

        try {
            // This is a special endpoint just for this purpose
            const response = await fetch(`${API_BASE}/users/create-admin`, {
                method: 'POST',
                headers: API_HEADERS, // <-- ADD HEADERS
                body: JSON.stringify({
                    username, password, email, firstName, lastName,
                    organizationId: parseInt(organizationId) // Ensure it's a number
                })
            });

            if (response.ok) {
                closeModal('tenantAdminModal');
                filterUsersByOrg(organizationId, document.getElementById('tenantAdminModalTitle').textContent.replace('Create Admin for: ',''));
            } else {
                const error = await response.json();
                alert('Failed to create admin: ' + (error.error || 'Username may be taken.'));
            }
        } catch (error) {
            console.error('Error creating tenant admin:', error);
            alert('Error creating tenant admin.');
        }
    }

    // --- 9. Global User CRUD ---

    // Helper to show/hide org dropdown based on role
    function toggleOrganizationDropdown(role) {
        const orgGroup = document.getElementById('userOrganizationGroup');
        const orgSelect = document.getElementById('userOrganizationId');
        const helpText = document.getElementById('userOrgHelpText');

        if (role === 'ROLE_SUPER_ADMIN') {
            orgGroup.style.display = 'none';
            orgSelect.value = ''; // Set to "None"
            helpText.style.display = 'none';
        } else {
            orgGroup.style.display = 'block';
            helpText.style.display = 'block';
            // If was "None", set to first available org
            if (orgSelect.value === '') {
                if(orgSelect.options.length > 1) {
                    orgSelect.value = orgSelect.options[1].value;
                }
            }
        }
    }

    function openCreateUserModal() {
        document.getElementById('userModalTitle').textContent = 'Create New User';
        document.getElementById('userId').value = '';
        document.getElementById('userUsername').value = '';
        document.getElementById('userPassword').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userFirstName').value = '';
        document.getElementById('userLastName').value = '';
        document.getElementById('userRole').value = 'ROLE_USER';
        document.getElementById('userActive').value = 'true';

        // Set org dropdown to first org
        const orgSelect = document.getElementById('userOrganizationId');
        if(orgSelect.options.length > 1) {
            orgSelect.value = orgSelect.options[1].value;
        } else {
            orgSelect.value = ''; // Default to "None"
        }
        toggleOrganizationDropdown('ROLE_USER');

        // Show password field and make it required
        document.getElementById('passwordGroup').style.display = 'block';
        document.getElementById('userPassword').required = true;
        openModal('userModal');
    }

    async function editUser(id) {
        try {
            const response = await fetch(`${API_BASE}/users/${id}`, { headers: API_HEADERS }); // <-- ADD HEADERS
            if (!response.ok) throw new Error('User not found');
            const user = await response.json();

            document.getElementById('userModalTitle').textContent = `Edit User: ${user.username}`;
            document.getElementById('userId').value = user.id;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userFirstName').value = user.firstName || '';
            document.getElementById('userLastName').value = user.lastName || '';
            document.getElementById('userRole').value = user.role;
            document.getElementById('userActive').value = user.active.toString();

            // --- THIS IS THE FIX ---
            // Set organization using the organizationName field if organization is null
            // But the user object *should* have the full org.
            document.getElementById('userOrganizationId').value = user.organization ? user.organization.id : '';
            toggleOrganizationDropdown(user.role);

            // Hide password field and make it not required
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('userPassword').required = false;

            openModal('userModal');
        } catch (error) {
            console.error('Error loading user:', error);
            alert('Error loading user data');
        }
    }

    async function saveUser() {
        const userId = document.getElementById('userId').value;
        const username = document.getElementById('userUsername').value;
        const password = document.getElementById('userPassword').value;
        const email = document.getElementById('userEmail').value;
        const firstName = document.getElementById('userFirstName').value;
        const lastName = document.getElementById('userLastName').value;
        const role = document.getElementById('userRole').value;
        const active = document.getElementById('userActive').value === 'true';
        let organizationId = document.getElementById('userOrganizationId').value;

        if (!username) {
            alert('Username is required');
            return;
        }

        // Password is required ONLY for new users
        if (!userId && !password) {
            alert('Password is required for new users');
            return;
        }

        // Validate organization based on role
        if (role === 'ROLE_SUPER_ADMIN') {
            organizationId = null; // Superadmins MUST have null org
        } else if (!organizationId || organizationId === '') {
            alert('Users and Tenant Admins must be assigned to an organization.');
            return;
        }

        const userData = {
            username, email, firstName, lastName, role, active,
            organizationId: organizationId ? parseInt(organizationId) : null
        };

        if (password && password.length > 0) { // Only include password if provided
            userData.password = password;
        }

        const url = userId ? `${API_BASE}/users/${userId}` : `${API_BASE}/users`;
        const method = userId ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: API_HEADERS, // <-- ADD HEADERS
                body: JSON.stringify(userData)
            });

            if (response.ok) {
                closeModal('userModal');
                loadGlobalUsers(); // Refresh the global list
            } else {
                const error = await response.json();
                alert('Failed to save user: ' + (error.error || 'Username may be taken.'));
            }
        } catch (error) {
            console.error('Error saving user:', error);
            alert('Error saving user');
        }
    }

    async function deleteUser(id, username) {
        if (!confirm(`Are you sure you want to delete user "${username}" (ID: ${id})?`)) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/users/${id}`, {
                method: 'DELETE',
                headers: API_HEADERS // <-- ADD HEADERS
            });

            if (response.ok) {
                loadGlobalUsers(); // Refresh the list
            } else {
                const error = await response.json();
                alert('Failed to delete user: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Error deleting user');
        }
    }

    async function loadBugReports() {
        try {
            const response = await fetch(`${API_BASE}/bugs`, { headers: API_HEADERS });
            if (!response.ok) throw new Error('Failed to fetch bug reports');
            const bugs = await response.json();

            const tbody = document.getElementById('bugReportsTableBody');
            tbody.innerHTML = '';

            // Update stats
            const openBugs = bugs.filter(b => b.status === 'OPEN').length;
            document.getElementById('totalOpenBugs').textContent = openBugs;

            if (bugs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üéâ</div>No bug reports found!</td></tr>';
                return;
            }

            bugs.forEach(bug => {
                const tr = document.createElement('tr');
                let statusBadge = 'badge-success'; // CLOSED
                if (bug.status === 'OPEN') statusBadge = 'badge-danger';
                if (bug.status === 'IN_PROGRESS') statusBadge = 'badge-warning';

                tr.innerHTML = `
                    <td>${bug.id}</td>
                    <td><span class="badge ${statusBadge}">${bug.status}</span></td>
                    <td><strong>${bug.organizationName || 'N/A'}</strong></td>
                    <td>${bug.reportedByUsername || 'N/A'}</td>
                    <td style="white-space: pre-wrap; word-break: break-word;">${bug.description}</td>
                    <td>${new Date(bug.createdAt).toLocaleString()}</td>
                    <td>
                        <select onchange="updateBugStatus(${bug.id}, this.value)">
                            <option value="OPEN" ${bug.status === 'OPEN' ? 'selected' : ''}>Open</option>
                            <option value="IN_PROGRESS" ${bug.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                            <option value="CLOSED" ${bug.status === 'CLOSED' ? 'selected' : ''}>Closed</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading bug reports:', error);
            const tbody = document.getElementById('bugReportsTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state" style="color: #721c24;">Failed to load bug reports.</td></tr>';
        }
    }

    async function updateBugStatus(bugId, newStatus) {
        try {
            const response = await fetch(`${API_BASE}/bugs/${bugId}/status`, {
                method: 'PUT',
                headers: API_HEADERS,
                body: JSON.stringify({ status: newStatus })
            });

            if (response.ok) {
                // Refresh the list to show the change
                loadBugReports();
            } else {
                const error = await response.json();
                alert('Failed to update status: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error updating bug status:', error);
            alert('Error updating bug status.');
        }
    }



</script>
</body>
</html>

