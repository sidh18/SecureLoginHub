<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        /* --- FIX: --- */
        /* This class will be added/removed by JavaScript */
        body.modal-open {
            overflow: hidden;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 40px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 24px;
        }

        .navbar-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            background: #f0f0f0;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-header h2 {
            color: #333;
            font-size: 22px;
        }

        .sso-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .sso-status {
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .sso-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .sso-type-btn {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .sso-type-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .sso-type-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .sso-type-btn h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .sso-type-btn p {
            font-size: 12px;
            color: #666;
        }

        .sso-type-btn.active p {
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-primary {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-buttons button {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;

            /* --- FIX 1: --- */
            /* Make the modal overlay scrollable and add padding */
            overflow-y: auto;
            padding: 5vh 0; /* Add vertical padding for spacing */
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            /* --- FIX 2: --- */
            /* Remove fixed margin, use auto for horizontal centering */
            margin: 0 auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;

            /* --- FIX 3: --- */
            /* Set a max-height and use flex-column layout */
            max-height: 90vh; /* Ensure modal is never taller than 90% of viewport */
            display: flex;
            flex-direction: column;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 25px;
            /* --- FIX 4: --- */
            /* Allow the modal body (the form) to scroll */
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>

<!-- ... Your entire <body> HTML (navbar, container, etc.) goes here ... -->
<!-- ... I am omitting it for brevity, but it's identical to your file ... -->

<div class="navbar">
    <h1>üõ°Ô∏è Admin Dashboard</h1>
    <div class="navbar-right">
        <span>Welcome, <strong th:text="${adminUsername}"></strong></span>
        <a href="/home" class="btn btn-primary">üë§ User View</a>
        <form th:action="@{/logout}" method="post" style="margin: 0;">
            <button type="submit" class="btn btn-danger">Logout</button>
        </form>
    </div>
</div>

<div class="container">
    <!-- Statistics -->
    <div class="stats">
        <div class="stat-card">
            <h3 id="totalUsers">0</h3>
            <p>Total Users</p>
        </div>
        <div class="stat-card">
            <h3 id="activeUsers">0</h3>
            <p>Active Users</p>
        </div>
        <div class="stat-card">
            <h3 id="adminUsers">0</h3>
            <p>Admin Users</p>
        </div>
        <div class="stat-card">
            <h3 id="ssoUsers">0</h3>
            <p>SSO Users</p>
        </div>
    </div>

    <!-- SSO Configuration -->
    <div class="card">
        <div class="card-header">
            <h2>üîê SSO Configuration</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="openCreateSsoModal('JWT')">+ Add JWT SSO</button>
                <button class="btn btn-success" onclick="openCreateSsoModal('OAUTH')">+ Add OAuth SSO</button>
                <button class="btn btn-success" onclick="openCreateSsoModal('SAML')">+ Add SAML SSO</button>
            </div>
        </div>

        <table id="ssoConfigsTable">
            <thead>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Last Modified</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="ssoConfigsTableBody">
            <!-- Dynamic content -->
            </tbody>
        </table>

        <!--
            --- FIX: ---
            Removed the confusing/broken "sso-config" and "sso-types" divs.
            The table above ("ssoConfigsTable") already contains the
            individual, working toggle switches for each SSO configuration.
        -->

    </div>

    <!-- User Management -->
    <div class="card">
        <div class="card-header">
            <h2>üë• User Management</h2>
            <button class="btn btn-success" onclick="openCreateUserModal()">+ Create User</button>
        </div>

        <table id="usersTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Name</th>
                <th>Role</th>
                <th>Status</th>
                <th>Created Via</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="usersTableBody">
            <!-- Dynamic content -->
            </tbody>
        </table>
    </div>
</div>

<!-- JWT Configuration Modal -->
<div id="jwtModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="jwtModalTitle">JWT Configuration</h3>
            <button class="close" onclick="closeModal('jwtModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="jwtConfigId">
            <div class="form-group">
                <label>Configuration Name *</label>
                <input type="text" id="jwtName" placeholder="e.g., MiniOrange JWT">
            </div>
            <div class="form-group">
                <label>Client ID *</label>
                <input type="text" id="jwtClientId" placeholder="Enter JWT Client ID">
            </div>
            <div class="form-group">
                <label>SSO URL *</label>
                <input type="text" id="jwtSsoUrl" placeholder="https://example.miniorange.com/sso">
            </div>
            <div class="form-group">
                <label>Callback URL *</label>
                <input type="text" id="jwtCallbackUrl" placeholder="http://localhost:8080/sso/callback">
            </div>
            <div class="form-group">
                <label>Logout URL</label>
                <input type="text" id="jwtLogoutUrl" placeholder="https://example.miniorange.com/logout">
            </div>
            <div class="form-group">
                <label>Priority (0 = highest)</label>
                <input type="number" id="jwtPriority" value="0" min="0">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('jwtModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveJwtConfig()">Save Configuration</button>
        </div>
    </div>
</div>

<!-- OAuth Configuration Modal -->
<div id="oauthModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="oauthModalTitle">OAuth Configuration</h3>
            <button class="close" onclick="closeModal('oauthModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="oauthConfigId">
            <div class="form-group">
                <label>Configuration Name *</label>
                <input type="text" id="oauthName" placeholder="e.g., MiniOrange OAuth">
            </div>
            <div class="form-group">
                <label>Client ID *</label>
                <input type="text" id="oauthClientId" placeholder="Enter OAuth Client ID">
            </div>
            <div class="form-group">
                <label>Client Secret *</label>
                <input type="password" id="oauthClientSecret" placeholder="Enter OAuth Client Secret">
            </div>
            <div class="form-group">
                <label>Authorization URL *</label>
                <input type="text" id="oauthAuthUrl" placeholder="https://example.com/oauth/authorize">
            </div>
            <div class="form-group">
                <label>Token URL *</label>
                <input type="text" id="oauthTokenUrl" placeholder="https://example.com/oauth/token">
            </div>
            <div class="form-group">
                <label>Callback URL *</label>
                <input type="text" id="oauthCallbackUrl" placeholder="http://localhost:8080/oauth/callback">
            </div>
            <div class="form-group">
                <label>User Info URL</label>
                <input type="text" id="oauthUserInfoUrl" placeholder="https://example.com/oauth/userinfo">
            </div>
            <div class="form-group">
                <label>Priority (0 = highest)</label>
                <input type="number" id="oauthPriority" value="0" min="0">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('oauthModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveOAuthConfig()">Save Configuration</button>
        </div>
    </div>
</div>

<!-- SAML Configuration Modal -->
<div id="samlModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="samlModalTitle">SAML Configuration</h3>
            <button class="close" onclick="closeModal('samlModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="samlConfigId">

            <!-- IDP Metadata Import -->
            <div id="idpMetadataSection" class="form-group" style="background: #f0f8ff; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <label><strong>üì• Import IDP Metadata (Optional)</strong></label>
                <p style="font-size: 12px; color: #666; margin: 5px 0;">
                    Paste your MiniOrange IDP metadata XML below to auto-fill configuration fields
                </p>
                <textarea id="idpMetadata" placeholder="Paste IDP metadata XML here..." style="min-height: 100px;"></textarea>
                <button type="button" class="btn btn-primary" onclick="parseIdpMetadata()" style="margin-top: 10px;">
                    Parse and Auto-Fill
                </button>
            </div>

            <div class="form-group">
                <label>Configuration Name *</label>
                <input type="text" id="samlName" placeholder="e.g., MiniOrange SAML">
            </div>

            <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>üì§ SP Configuration (Share with MiniOrange)</strong>
            </div>

            <div class="form-group">
                <label>SP Entity ID (Issuer) *</label>
                <input type="text" id="samlEntityId" placeholder="http://localhost:8080">
                <p style="font-size: 11px; color: #666; margin-top: 5px;">
                    Share this with MiniOrange as "Issuer ID"
                </p>
            </div>
            <div class="form-group">
                <label>ACS URL (Assertion Consumer Service) *</label>
                <input type="text" id="samlAcsUrl" placeholder="http://localhost:8080/saml/acs">
                <p style="font-size: 11px; color: #666; margin-top: 5px;">
                    Share this with MiniOrange as "ACS URL"
                </p>
            </div>

            <div style="background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 15px 0;">
                <strong>üì• IDP Configuration (From MiniOrange)</strong>
            </div>

            <div class="form-group">
                <label>IDP Entity ID *</label>
                <input type="text" id="samlIdpEntityId" placeholder="https://login.xecurify.com">
            </div>
            <div class="form-group">
                <label>IDP SSO URL *</label>
                <input type="text" id="samlSsoUrl" placeholder="https://login.xecurify.com/moas/idp/saml">
            </div>
            <div class="form-group">
                <label>IDP X.509 Certificate *</label>
                <textarea id="samlCertificate" placeholder="-----BEGIN CERTIFICATE-----&#10;MIIDXTCCAkWgAwIBAgIJ...&#10;-----END CERTIFICATE-----"></textarea>
            </div>
            <div class="form-group">
                <label>Priority (0 = highest)</label>
                <input type="number" id="samlPriority" value="0" min="0">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('samlModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveSamlConfig()">Save Configuration</button>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="userModalTitle">Create New User</h3>
            <button class="close" onclick="closeModal('userModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="userId">
            <div class="form-group">
                <label>Username *</label>
                <input type="text" id="userUsername" placeholder="Enter username">
            </div>
            <div class="form-group" id="passwordGroup">
                <label>Password *</label>
                <input type="password" id="userPassword" placeholder="Enter password">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="userEmail" placeholder="Enter email">
            </div>
            <div class="form-group">
                <label>First Name</label>
                <input type="text" id="userFirstName" placeholder="Enter first name">
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="userLastName" placeholder="Enter last name">
            </div>
            <div class="form-group">
                <label>Role *</label>
                <select id="userRole">
                    <option value="USER">User</option>
                    <option value="ADMIN">Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="userActive">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveUser()">Save User</button>
        </div>
    </div>
</div>

<script>
    // Load users on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
    });

    // Load all users
    async function loadUsers() {
        try {
            const response = await fetch('/admin/api/users');
            const users = await response.json();

            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            // Update statistics
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeUsers').textContent = users.filter(u => u.active).length;
            document.getElementById('adminUsers').textContent = users.filter(u => u.role === 'ADMIN').length;
            document.getElementById('ssoUsers').textContent = users.filter(u => u.createdVia === 'SSO').length;

            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email || '-'}</td>
                    <td>${user.firstName || ''} ${user.lastName || ''}</td>
                    <td><span class="badge ${user.role === 'ADMIN' ? 'badge-primary' : 'badge-success'}">${user.role}</span></td>
                    <td><span class="badge ${user.active ? 'badge-success' : 'badge-danger'}">${user.active ? 'Active' : 'Inactive'}</span></td>
                    <td><span class="badge ${user.createdVia === 'SSO' ? 'badge-warning' : 'badge-primary'}">${user.createdVia || 'REGULAR'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="editUser(${user.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id}, '${user.username}')">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading users:', error);
            alert('Failed to load users');
        }
    }

    /*
        --- FIX: ---
        Removed the broken "ssoToggle" event listener.
        The correct toggle functionality is handled by the
        "toggleSsoConfig(id, enabled)" function which is
        called from the table.
    */

    // Modal functions
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
        /* --- FIX 5: --- */
        /* Add class to body to disable background scrolling */
        document.body.classList.add('modal-open');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        /* --- FIX 6: --- */
        /* Remove class from body to re-enable background scrolling */
        document.body.classList.remove('modal-open');
    }

    function openJwtModal() {
        openModal('jwtModal');
    }

    function openOAuthModal() {
        openModal('oauthModal');
    }

    function openSamlModal() {
        openModal('samlModal');
    }

    function openCreateUserModal() {
        document.getElementById('userModalTitle').textContent = 'Create New User';
        document.getElementById('userId').value = '';
        document.getElementById('userUsername').value = '';
        document.getElementById('userPassword').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userFirstName').value = '';
        document.getElementById('userLastName').value = '';
        document.getElementById('userRole').value = 'USER';
        document.getElementById('userActive').value = 'true';
        document.getElementById('passwordGroup').style.display = 'block';
        openModal('userModal');
    }

    // Save JWT Configuration
    async function saveJwtConfig() {
        const clientId = document.getElementById('jwtClientId').value;
        const ssoUrl = document.getElementById('jwtSsoUrl').value;
        const callbackUrl = document.getElementById('jwtCallbackUrl').value;
        const logoutUrl = document.getElementById('jwtLogoutUrl').value;

        if (!clientId || !ssoUrl || !callbackUrl) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const response = await fetch('/admin/api/sso-config/jwt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    clientId: clientId,
                    ssoUrl: ssoUrl,
                    callbackUrl: callbackUrl,
                    logoutUrl: logoutUrl
                })
            });

            if (response.ok) {
                alert('JWT configuration saved successfully!');
                closeModal('jwtModal');
                location.reload();
            } else {
                alert('Failed to save JWT configuration');
            }
        } catch (error) {
            console.error('Error saving JWT config:', error);
            alert('Error saving configuration');
        }
    }

    // Save OAuth Configuration
    async function saveOAuthConfig() {
        const clientId = document.getElementById('oauthClientId').value;
        const clientSecret = document.getElementById('oauthClientSecret').value;
        const authUrl = document.getElementById('oauthAuthUrl').value;
        const tokenUrl = document.getElementById('oauthTokenUrl').value;
        const callbackUrl = document.getElementById('oauthCallbackUrl').value;

        if (!clientId || !clientSecret || !authUrl || !tokenUrl || !callbackUrl) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const response = await fetch('/admin/api/sso-config/oauth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    clientId: clientId,
                    clientSecret: clientSecret,
                    authorizationUrl: authUrl,
                    tokenUrl: tokenUrl,
                    callbackUrl: callbackUrl
                })
            });

            if (response.ok) {
                alert('OAuth configuration saved successfully!');
                closeModal('oauthModal');
                location.reload();
            } else {
                alert('Failed to save OAuth configuration');
            }
        } catch (error) {
            console.error('Error saving OAuth config:', error);
            alert('Error saving configuration');
        }
    }

    // Save SAML Configuration
    async function saveSamlConfig() {
        const entityId = document.getElementById('samlEntityId').value;
        const ssoUrl = document.getElementById('samlSsoUrl').value;
        const certificate = document.getElementById('samlCertificate').value;
        const callbackUrl = document.getElementById('samlCallbackUrl').value;

        if (!entityId || !ssoUrl || !certificate || !callbackUrl) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const response = await fetch('/admin/api/sso-config/saml', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entityId: entityId,
                    ssoUrl: ssoUrl,
                    certificate: certificate,
                    callbackUrl: callbackUrl
                })
            });

            if (response.ok) {
                alert('SAML configuration saved successfully!');
                closeModal('samlModal');
                location.reload();
            } else {
                alert('Failed to save SAML configuration');
            }
        } catch (error) {
            console.error('Error saving SAML config:', error);
            alert('Error saving configuration');
        }
    }

    // Create or Update User
    async function saveUser() {
        const userId = document.getElementById('userId').value;
        const username = document.getElementById('userUsername').value;
        const password = document.getElementById('userPassword').value;
        const email = document.getElementById('userEmail').value;
        const firstName = document.getElementById('userFirstName').value;
        const lastName = document.getElementById('userLastName').value;
        const role = document.getElementById('userRole').value;
        const active = document.getElementById('userActive').value === 'true';

        if (!username) {
            alert('Username is required');
            return;
        }

        if (!userId && !password) {
            alert('Password is required for new users');
            return;
        }

        const userData = {
            username: username,
            email: email,
            firstName: firstName,
            lastName: lastName,
            role: role,
            active: active
        };

        if (password) {
            userData.password = password;
        }

        try {
            let response;
            if (userId) {
                // Update existing user
                response = await fetch(`/admin/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
            } else {
                // Create new user
                response = await fetch('/admin/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
            }

            if (response.ok) {
                alert(userId ? 'User updated successfully!' : 'User created successfully!');
                closeModal('userModal');
                loadUsers();
            } else {
                const error = await response.json();
                alert('Failed to save user: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error saving user:', error);
            alert('Error saving user');
        }
    }

    // Edit User
    async function editUser(id) {
        try {
            const response = await fetch('/admin/api/users');
            const users = await response.json();
            const user = users.find(u => u.id === id);

            if (!user) {
                alert('User not found');
                return;
            }

            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = user.id;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userFirstName').value = user.firstName || '';
            document.getElementById('userLastName').value = user.lastName || '';
            document.getElementById('userRole').value = user.role;
            document.getElementById('userActive').value = user.active.toString();
            document.getElementById('passwordGroup').style.display = 'none';

            openModal('userModal');
        } catch (error) {
            console.error('Error loading user:', error);
            alert('Error loading user');
        }
    }

    // Delete User
    async function deleteUser(id, username) {
        if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
            return;
        }

        try {
            const response = await fetch(`/admin/api/users/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('User deleted successfully!');
                loadUsers();
            } else {
                alert('Failed to delete user');
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Error deleting user');
        }
    }
    // Load SSO configurations
    async function loadSsoConfigs() {
        try {
            const response = await fetch('/admin/api/sso-configs');
            const configs = await response.json();

            const tbody = document.getElementById('ssoConfigsTableBody');
            tbody.innerHTML = '';

            if (configs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No SSO configurations found. Click "Add" button to create one.</td></tr>';
                return;
            }

            configs.forEach(config => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td><strong>${config.name}</strong></td>
                <td><span class="badge badge-primary">${config.ssoType}</span></td>

                <!-- --- FIX: --- -->
                <!-- Replaced toggle switch with a clickable tick/cross icon -->
                <td style="text-align: center;">
                    <span style="font-size: 24px; cursor: pointer; color: ${config.enabled ? '#28a745' : '#dc3545'};"
                          onclick="toggleSsoConfig(${config.id}, ${!config.enabled})">
                        ${config.enabled ? '&#10004;' : '&#10006;'}
                    </span>
                </td>

                <td>${config.priority}</td>
                <td>${config.lastModifiedAt ? new Date(config.lastModifiedAt).toLocaleString() : '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="editSsoConfig(${config.id})">Edit</button>
                        ${config.ssoType === 'SAML' ? `<button class="btn btn-primary" onclick="viewSamlMetadata(${config.id})">Metadata</button>` : ''}
                        <button class="btn btn-danger" onclick="deleteSsoConfig(${config.id}, '${config.name}')">Delete</button>
                    </div>
                </td>
            `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading SSO configs:', error);
        }
    }

    // Toggle SSO configuration
    async function toggleSsoConfig(id, enabled) {
        try {
            const response = await fetch(`/admin/api/sso-configs/${id}/toggle`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ enabled: enabled })
            });

            if (response.ok) {
                alert(`SSO configuration ${enabled ? 'enabled' : 'disabled'} successfully!`);
                loadSsoConfigs();
            } else {
                alert('Failed to toggle SSO configuration');
            }
        } catch (error) {
            console.error('Error toggling SSO:', error);
            alert('Error toggling SSO configuration');
        }
    }

    // Open create SSO modal
    function openCreateSsoModal(type) {
        if (type === 'JWT') {
            document.getElementById('jwtModalTitle').textContent = 'Add JWT SSO Configuration';
            document.getElementById('jwtConfigId').value = '';
            document.getElementById('jwtName').value = '';
            document.getElementById('jwtClientId').value = '';
            document.getElementById('jwtSsoUrl').value = '';
            document.getElementById('jwtCallbackUrl').value = 'http://localhost:8080/sso/callback';
            document.getElementById('jwtLogoutUrl').value = '';
            document.getElementById('jwtPriority').value = '0';
            openModal('jwtModal');
        } else if (type === 'OAUTH') {
            document.getElementById('oauthModalTitle').textContent = 'Add OAuth SSO Configuration';
            document.getElementById('oauthConfigId').value = '';
            document.getElementById('oauthName').value = '';
            document.getElementById('oauthClientId').value = '';
            document.getElementById('oauthClientSecret').value = '';
            document.getElementById('oauthAuthUrl').value = '';
            document.getElementById('oauthTokenUrl').value = '';
            document.getElementById('oauthCallbackUrl').value = 'http://localhost:8080/oauth/callback';
            document.getElementById('oauthUserInfoUrl').value = '';
            document.getElementById('oauthPriority').value = '0';
            openModal('oauthModal');
        } else if (type === 'SAML') {
            document.getElementById('samlModalTitle').textContent = 'Add SAML SSO Configuration';
            document.getElementById('samlConfigId').value = '';
            document.getElementById('samlName').value = '';
            document.getElementById('samlEntityId').value = 'http://localhost:8080';
            document.getElementById('samlIdpEntityId').value = '';
            document.getElementById('samlSsoUrl').value = '';
            document.getElementById('samlCertificate').value = '';
            document.getElementById('samlAcsUrl').value = 'http://localhost:8080/saml/acs';
            document.getElementById('samlPriority').value = '0';
            document.getElementById('idpMetadataSection').style.display = 'block';
            openModal('samlModal');
        }
    }

    // Edit SSO configuration
    async function editSsoConfig(id) {
        try {
            const response = await fetch(`/admin/api/sso-configs/${id}`);
            const config = await response.json();

            if (config.ssoType === 'JWT') {
                document.getElementById('jwtModalTitle').textContent = 'Edit JWT SSO Configuration';
                document.getElementById('jwtConfigId').value = config.id;
                document.getElementById('jwtName').value = config.name;
                document.getElementById('jwtClientId').value = config.jwtClientId || '';
                document.getElementById('jwtSsoUrl').value = config.jwtSsoUrl || '';
                document.getElementById('jwtCallbackUrl').value = config.jwtCallbackUrl || '';
                document.getElementById('jwtLogoutUrl').value = config.jwtLogoutUrl || '';
                document.getElementById('jwtPriority').value = config.priority || 0;
                openModal('jwtModal');
            } else if (config.ssoType === 'OAUTH') {
                document.getElementById('oauthModalTitle').textContent = 'Edit OAuth SSO Configuration';
                document.getElementById('oauthConfigId').value = config.id;
                document.getElementById('oauthName').value = config.name;
                document.getElementById('oauthClientId').value = config.oauthClientId || '';
                document.getElementById('oauthClientSecret').value = config.oauthClientSecret || '';
                document.getElementById('oauthAuthUrl').value = config.oauthAuthorizationUrl || '';
                document.getElementById('oauthTokenUrl').value = config.oauthTokenUrl || '';
                document.getElementById('oauthCallbackUrl').value = config.oauthCallbackUrl || '';
                document.getElementById('oauthUserInfoUrl').value = config.oauthUserInfoUrl || '';
                document.getElementById('oauthPriority').value = config.priority || 0;
                openModal('oauthModal');
            } else if (config.ssoType === 'SAML') {
                document.getElementById('samlModalTitle').textContent = 'Edit SAML SSO Configuration';
                document.getElementById('samlConfigId').value = config.id;
                document.getElementById('samlName').value = config.name;
                document.getElementById('samlEntityId').value = config.samlEntityId || '';
                document.getElementById('samlIdpEntityId').value = config.samlIdpEntityId || '';
                document.getElementById('samlSsoUrl').value = config.samlSsoUrl || '';
                document.getElementById('samlCertificate').value = config.samlX509Certificate || '';
                document.getElementById('samlAcsUrl').value = config.samlAcsUrl || '';
                document.getElementById('samlPriority').value = config.priority || 0;
                document.getElementById('idpMetadataSection').style.display = 'block';
                openModal('samlModal');
            }
        } catch (error) {
            console.error('Error loading SSO config:', error);
            alert('Error loading SSO configuration');
        }
    }

    // Delete SSO configuration
    async function deleteSsoConfig(id, name) {
        if (!confirm(`Are you sure you want to delete SSO configuration "${name}"?`)) {
            return;
        }

        try {
            const response = await fetch(`/admin/api/sso-configs/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('SSO configuration deleted successfully!');
                loadSsoConfigs();
            } else {
                alert('Failed to delete SSO configuration');
            }
        } catch (error) {
            console.error('Error deleting SSO config:', error);
            alert('Error deleting SSO configuration');
        }
    }

    // View SAML Metadata
    async function viewSamlMetadata(id) {
        try {
            const response = await fetch(`/admin/api/sso-configs/${id}`);
            const config = await response.json();

            if (config.samlSpMetadata) {
                const metadataWindow = window.open('', 'SAML Metadata', 'width=800,height=600');
                metadataWindow.document.write('<html><head><title>SAML SP Metadata</title></head><body>');
                metadataWindow.document.write('<h2>Service Provider (SP) Metadata</h2>');
                metadataWindow.document.write('<p>Share this metadata with your Identity Provider (MiniOrange)</p>');
                metadataWindow.document.write('<textarea style="width:100%;height:400px;font-family:monospace;">');
                metadataWindow.document.write(config.samlSpMetadata);
                metadataWindow.document.write('</textarea>');
                metadataWindow.document.write('<br><button onclick="navigator.clipboard.writeText(document.querySelector(\'textarea\').value);alert(\'Copied!\')">Copy to Clipboard</button>');
                metadataWindow.document.write('</body></html>');
            } else {
                alert('No metadata available');
            }
        } catch (error) {
            console.error('Error loading metadata:', error);
            alert('Error loading metadata');
        }
    }

    // Parse IDP Metadata
    async function parseIdpMetadata() {
        const metadata = document.getElementById('idpMetadata').value;

        if (!metadata) {
            alert('Please paste IDP metadata XML');
            return;
        }

        try {
            const response = await fetch('/admin/api/sso-configs/saml/parse-metadata', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ metadata: metadata })
            });

            if (response.ok) {
                const data = await response.json();

                // Auto-fill form fields
                if (data.entityId) {
                    document.getElementById('samlIdpEntityId').value = data.entityId;
                }
                if (data.ssoUrl) {
                    document.getElementById('samlSsoUrl').value = data.ssoUrl;
                }
                if (data.certificate) {
                    document.getElementById('samlCertificate').value = data.certificate;
                }

                alert('IDP metadata parsed successfully! Fields have been auto-filled.');
            } else {
                alert('Failed to parse IDP metadata');
            }
        } catch (error) {
            console.error('Error parsing metadata:', error);
            alert('Error parsing IDP metadata');
        }
    }

    // Update the existing saveJwtConfig function
    async function saveJwtConfig() {
        const id = document.getElementById('jwtConfigId').value;
        const name = document.getElementById('jwtName').value;
        const clientId = document.getElementById('jwtClientId').value;
        const ssoUrl = document.getElementById('jwtSsoUrl').value;
        const callbackUrl = document.getElementById('jwtCallbackUrl').value;
        const logoutUrl = document.getElementById('jwtLogoutUrl').value;
        const priority = parseInt(document.getElementById('jwtPriority').value);

        if (!name || !clientId || !ssoUrl || !callbackUrl) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const response = await fetch('/admin/api/sso-configs/jwt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: id || null,
                    name: name,
                    clientId: clientId,
                    ssoUrl: ssoUrl,
                    callbackUrl: callbackUrl,
                    logoutUrl: logoutUrl,
                    priority: priority
                })
            });

            if (response.ok) {
                alert('JWT SSO configuration saved successfully!');
                closeModal('jwtModal');
                loadSsoConfigs();
            } else {
                alert('Failed to save JWT SSO configuration');
            }
        } catch (error) {
            console.error('Error saving JWT config:', error);
            alert('Error saving configuration');
        }
    }

    // Update the existing saveOAuthConfig function
    async function saveOAuthConfig() {
        const id = document.getElementById('oauthConfigId').value;
        const name = document.getElementById('oauthName').value;
        const clientId = document.getElementById('oauthClientId').value;
        const clientSecret = document.getElementById('oauthClientSecret').value;
        const authUrl = document.getElementById('oauthAuthUrl').value;
        const tokenUrl = document.getElementById('oauthTokenUrl').value;
        const callbackUrl = document.getElementById('oauthCallbackUrl').value;
        const userInfoUrl = document.getElementById('oauthUserInfoUrl').value;
        const priority = parseInt(document.getElementById('oauthPriority').value);

        if (!name || !clientId || !clientSecret || !authUrl || !tokenUrl || !callbackUrl) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const response = await fetch('/admin/api/sso-configs/oauth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: id || null,
                    name: name,
                    clientId: clientId,
                    clientSecret: clientSecret,
                    authorizationUrl: authUrl,
                    tokenUrl: tokenUrl,
                    callbackUrl: callbackUrl,
                    userInfoUrl: userInfoUrl,
                    priority: priority
                })
            });

            if (response.ok) {
                alert('OAuth SSO configuration saved successfully!');
                closeModal('oauthModal');
                loadSsoConfigs();
            } else {
                alert('Failed to save OAuth SSO configuration');
            }
        } catch (error) {
            console.error('Error saving OAuth config:', error);
            alert('Error saving configuration');
        }
    }

    // Update the existing saveSamlConfig function
    async function saveSamlConfig() {
        const id = document.getElementById('samlConfigId').value;
        const name = document.getElementById('samlName').value;
        const entityId = document.getElementById('samlEntityId').value;
        const idpEntityId = document.getElementById('samlIdpEntityId').value;
        const ssoUrl = document.getElementById('samlSsoUrl').value;
        const certificate = document.getElementById('samlCertificate').value;
        const acsUrl = document.getElementById('samlAcsUrl').value;
        const priority = parseInt(document.getElementById('samlPriority').value);

        if (!name || !entityId || !idpEntityId || !ssoUrl || !certificate || !acsUrl) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const response = await fetch('/admin/api/sso-configs/saml', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: id || null,
                    name: name,
                    entityId: entityId,
                    idpEntityId: idpEntityId,
                    ssoUrl: ssoUrl,
                    certificate: certificate,
                    acsUrl: acsUrl,
                    priority: priority
                })
            });

            if (response.ok) {
                alert('SAML SSO configuration saved successfully!');
                closeModal('samlModal');
                loadSsoConfigs();
            } else {
                alert('Failed to save SAML SSO configuration');
            }
        } catch (error) {
            console.error('Error saving SAML config:', error);
            alert('Error saving configuration');
        }
    }

    // Load configurations on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
        loadSsoConfigs();
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
            /* --- FIX 7: --- */
            /* Re-enable background scrolling */
            document.body.classList.remove('modal-open');
        }
    }
</script>
</body>
</html>

