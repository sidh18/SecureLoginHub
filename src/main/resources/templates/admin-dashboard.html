<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 40px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 24px;
        }

        .navbar-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            background: #f0f0f0;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-header h2 {
            color: #333;
            font-size: 22px;
        }

        .sso-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .sso-status {
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .sso-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .sso-type-btn {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .sso-type-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .sso-type-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .sso-type-btn h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .sso-type-btn p {
            font-size: 12px;
            color: #666;
        }

        .sso-type-btn.active p {
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-primary {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-buttons button {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="navbar">
    <h1>üõ°Ô∏è Admin Dashboard</h1>
    <div class="navbar-right">
        <span>Welcome, <strong th:text="${adminUsername}"></strong></span>
        <a href="/home" class="btn btn-primary">üë§ User View</a>
        <form th:action="@{/logout}" method="post" style="margin: 0;">
            <button type="submit" class="btn btn-danger">Logout</button>
        </form>
    </div>
</div>

<div class="container">
    <!-- Statistics -->
    <div class="stats">
        <div class="stat-card">
            <h3 id="totalUsers">0</h3>
            <p>Total Users</p>
        </div>
        <div class="stat-card">
            <h3 id="activeUsers">0</h3>
            <p>Active Users</p>
        </div>
        <div class="stat-card">
            <h3 id="adminUsers">0</h3>
            <p>Admin Users</p>
        </div>
        <div class="stat-card">
            <h3 id="ssoUsers">0</h3>
            <p>SSO Users</p>
        </div>
    </div>

    <!-- SSO Configuration -->
    <div class="card">
        <div class="card-header">
            <h2>üîê SSO Configuration</h2>
        </div>

        <div class="sso-config">
            <div class="sso-status">
                <div>
                    <strong>SSO Status</strong>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Enable or disable SSO authentication
                    </p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="ssoToggle" th:checked="${ssoConfig.ssoEnabled}">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="sso-status">
                <div>
                    <strong>Current SSO Type</strong>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        <span th:text="${ssoConfig.ssoType != null ? ssoConfig.ssoType : 'Not Configured'}"></span>
                    </p>
                </div>
            </div>
        </div>

        <div class="sso-types">
            <div class="sso-type-btn" onclick="openJwtModal()"
                 th:classappend="${ssoConfig.ssoType == 'JWT' ? 'active' : ''}">
                <h3>üîë JWT</h3>
                <p>JSON Web Token based authentication</p>
            </div>
            <div class="sso-type-btn" onclick="openOAuthModal()"
                 th:classappend="${ssoConfig.ssoType == 'OAUTH' ? 'active' : ''}">
                <h3>üîì OAuth</h3>
                <p>OAuth 2.0 authentication</p>
            </div>
            <div class="sso-type-btn" onclick="openSamlModal()"
                 th:classappend="${ssoConfig.ssoType == 'SAML' ? 'active' : ''}">
                <h3>üõ°Ô∏è SAML</h3>
                <p>SAML 2.0 authentication</p>
            </div>
        </div>
    </div>

    <!-- User Management -->
    <div class="card">
        <div class="card-header">
            <h2>üë• User Management</h2>
            <button class="btn btn-success" onclick="openCreateUserModal()">+ Create User</button>
        </div>

        <table id="usersTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Name</th>
                <th>Role</th>
                <th>Status</th>
                <th>Created Via</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="usersTableBody">
            <!-- Dynamic content -->
            </tbody>
        </table>
    </div>
</div>

<!-- JWT Configuration Modal -->
<div id="jwtModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üîë JWT Configuration</h3>
            <button class="close" onclick="closeModal('jwtModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Client ID *</label>
                <input type="text" id="jwtClientId" placeholder="Enter JWT Client ID"
                       th:value="${ssoConfig.jwtClientId}">
            </div>
            <div class="form-group">
                <label>SSO URL *</label>
                <input type="text" id="jwtSsoUrl" placeholder="https://example.miniorange.com/sso"
                       th:value="${ssoConfig.jwtSsoUrl}">
            </div>
            <div class="form-group">
                <label>Callback URL *</label>
                <input type="text" id="jwtCallbackUrl" placeholder="http://localhost:8080/sso/callback"
                       th:value="${ssoConfig.jwtCallbackUrl}">
            </div>
            <div class="form-group">
                <label>Logout URL</label>
                <input type="text" id="jwtLogoutUrl" placeholder="https://example.miniorange.com/logout"
                       th:value="${ssoConfig.jwtLogoutUrl}">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('jwtModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveJwtConfig()">Save Configuration</button>
        </div>
    </div>
</div>

<!-- OAuth Configuration Modal -->
<div id="oauthModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üîì OAuth Configuration</h3>
            <button class="close" onclick="closeModal('oauthModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Client ID *</label>
                <input type="text" id="oauthClientId" placeholder="Enter OAuth Client ID"
                       th:value="${ssoConfig.oauthClientId}">
            </div>
            <div class="form-group">
                <label>Client Secret *</label>
                <input type="password" id="oauthClientSecret" placeholder="Enter OAuth Client Secret"
                       th:value="${ssoConfig.oauthClientSecret}">
            </div>
            <div class="form-group">
                <label>Authorization URL *</label>
                <input type="text" id="oauthAuthUrl" placeholder="https://example.com/oauth/authorize"
                       th:value="${ssoConfig.oauthAuthorizationUrl}">
            </div>
            <div class="form-group">
                <label>Token URL *</label>
                <input type="text" id="oauthTokenUrl" placeholder="https://example.com/oauth/token"
                       th:value="${ssoConfig.oauthTokenUrl}">
            </div>
            <div class="form-group">
                <label>Callback URL *</label>
                <input type="text" id="oauthCallbackUrl" placeholder="http://localhost:8080/oauth/callback"
                       th:value="${ssoConfig.oauthCallbackUrl}">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('oauthModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveOAuthConfig()">Save Configuration</button>
        </div>
    </div>
</div>

<!-- SAML Configuration Modal -->
<div id="samlModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üõ°Ô∏è SAML Configuration</h3>
            <button class="close" onclick="closeModal('samlModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Entity ID *</label>
                <input type="text" id="samlEntityId" placeholder="Enter SAML Entity ID"
                       th:value="${ssoConfig.samlEntityId}">
            </div>
            <div class="form-group">
                <label>SSO URL *</label>
                <input type="text" id="samlSsoUrl" placeholder="https://example.com/saml/sso"
                       th:value="${ssoConfig.samlSsoUrl}">
            </div>
            <div class="form-group">
                <label>X.509 Certificate *</label>
                <textarea id="samlCertificate" placeholder="-----BEGIN CERTIFICATE-----&#10;...&#10;-----END CERTIFICATE-----"
                          th:text="${ssoConfig.samlX509Certificate}"></textarea>
            </div>
            <div class="form-group">
                <label>Callback URL *</label>
                <input type="text" id="samlCallbackUrl" placeholder="http://localhost:8080/saml/callback"
                       th:value="${ssoConfig.samlCallbackUrl}">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('samlModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveSamlConfig()">Save Configuration</button>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="userModalTitle">Create New User</h3>
            <button class="close" onclick="closeModal('userModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="userId">
            <div class="form-group">
                <label>Username *</label>
                <input type="text" id="userUsername" placeholder="Enter username">
            </div>
            <div class="form-group" id="passwordGroup">
                <label>Password *</label>
                <input type="password" id="userPassword" placeholder="Enter password">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="userEmail" placeholder="Enter email">
            </div>
            <div class="form-group">
                <label>First Name</label>
                <input type="text" id="userFirstName" placeholder="Enter first name">
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="userLastName" placeholder="Enter last name">
            </div>
            <div class="form-group">
                <label>Role *</label>
                <select id="userRole">
                    <option value="USER">User</option>
                    <option value="ADMIN">Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="userActive">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveUser()">Save User</button>
        </div>
    </div>
</div>

<script>
    // Load users on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
    });

    // Load all users
    async function loadUsers() {
        try {
            const response = await fetch('/admin/api/users');
            const users = await response.json();

            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            // Update statistics
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeUsers').textContent = users.filter(u => u.active).length;
            document.getElementById('adminUsers').textContent = users.filter(u => u.role === 'ADMIN').length;
            document.getElementById('ssoUsers').textContent = users.filter(u => u.createdVia === 'SSO').length;

            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email || '-'}</td>
                    <td>${user.firstName || ''} ${user.lastName || ''}</td>
                    <td><span class="badge ${user.role === 'ADMIN' ? 'badge-primary' : 'badge-success'}">${user.role}</span></td>
                    <td><span class="badge ${user.active ? 'badge-success' : 'badge-danger'}">${user.active ? 'Active' : 'Inactive'}</span></td>
                    <td><span class="badge ${user.createdVia === 'SSO' ? 'badge-warning' : 'badge-primary'}">${user.createdVia || 'REGULAR'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="editUser(${user.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id}, '${user.username}')">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading users:', error);
            alert('Failed to load users');
        }
    }

    // SSO Toggle
    document.getElementById('ssoToggle').addEventListener('change', async function() {
        try {
            const response = await fetch('/admin/api/sso-config/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    enabled: this.checked
                })
            });

            if (response.ok) {
                alert('SSO status updated successfully!');
            } else {
                alert('Failed to update SSO status');
                this.checked = !this.checked;
            }
        } catch (error) {
            console.error('Error toggling SSO:', error);
            alert('Error updating SSO status');
            this.checked = !this.checked;
        }
    });

    // Modal functions
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function openJwtModal() {
        openModal('jwtModal');
    }

    function openOAuthModal() {
        openModal('oauthModal');
    }

    function openSamlModal() {
        openModal('samlModal');
    }

    function openCreateUserModal() {
        document.getElementById('userModalTitle').textContent = 'Create New User';
        document.getElementById('userId').value = '';
        document.getElementById('userUsername').value = '';
        document.getElementById('userPassword').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userFirstName').value = '';
        document.getElementById('userLastName').value = '';
        document.getElementById('userRole').value = 'USER';
        document.getElementById('userActive').value = 'true';
        document.getElementById('passwordGroup').style.display = 'block';
        openModal('userModal');
    }

    // Save JWT Configuration
    async function saveJwtConfig() {
        const clientId = document.getElementById('jwtClientId').value;
        const ssoUrl = document.getElementById('jwtSsoUrl').value;
        const callbackUrl = document.getElementById('jwtCallbackUrl').value;
        const logoutUrl = document.getElementById('jwtLogoutUrl').value;

        if (!clientId || !ssoUrl || !callbackUrl) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const response = await fetch('/admin/api/sso-config/jwt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    clientId: clientId,
                    ssoUrl: ssoUrl,
                    callbackUrl: callbackUrl,
                    logoutUrl: logoutUrl
                })
            });

            if (response.ok) {
                alert('JWT configuration saved successfully!');
                closeModal('jwtModal');
                location.reload();
            } else {
                alert('Failed to save JWT configuration');
            }
        } catch (error) {
            console.error('Error saving JWT config:', error);
            alert('Error saving configuration');
        }
    }

    // Save OAuth Configuration
    async function saveOAuthConfig() {
        const clientId = document.getElementById('oauthClientId').value;
        const clientSecret = document.getElementById('oauthClientSecret').value;
        const authUrl = document.getElementById('oauthAuthUrl').value;
        const tokenUrl = document.getElementById('oauthTokenUrl').value;
        const callbackUrl = document.getElementById('oauthCallbackUrl').value;

        if (!clientId || !clientSecret || !authUrl || !tokenUrl || !callbackUrl) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const response = await fetch('/admin/api/sso-config/oauth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    clientId: clientId,
                    clientSecret: clientSecret,
                    authorizationUrl: authUrl,
                    tokenUrl: tokenUrl,
                    callbackUrl: callbackUrl
                })
            });

            if (response.ok) {
                alert('OAuth configuration saved successfully!');
                closeModal('oauthModal');
                location.reload();
            } else {
                alert('Failed to save OAuth configuration');
            }
        } catch (error) {
            console.error('Error saving OAuth config:', error);
            alert('Error saving configuration');
        }
    }

    // Save SAML Configuration
    async function saveSamlConfig() {
        const entityId = document.getElementById('samlEntityId').value;
        const ssoUrl = document.getElementById('samlSsoUrl').value;
        const certificate = document.getElementById('samlCertificate').value;
        const callbackUrl = document.getElementById('samlCallbackUrl').value;

        if (!entityId || !ssoUrl || !certificate || !callbackUrl) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const response = await fetch('/admin/api/sso-config/saml', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entityId: entityId,
                    ssoUrl: ssoUrl,
                    certificate: certificate,
                    callbackUrl: callbackUrl
                })
            });

            if (response.ok) {
                alert('SAML configuration saved successfully!');
                closeModal('samlModal');
                location.reload();
            } else {
                alert('Failed to save SAML configuration');
            }
        } catch (error) {
            console.error('Error saving SAML config:', error);
            alert('Error saving configuration');
        }
    }

    // Create or Update User
    async function saveUser() {
        const userId = document.getElementById('userId').value;
        const username = document.getElementById('userUsername').value;
        const password = document.getElementById('userPassword').value;
        const email = document.getElementById('userEmail').value;
        const firstName = document.getElementById('userFirstName').value;
        const lastName = document.getElementById('userLastName').value;
        const role = document.getElementById('userRole').value;
        const active = document.getElementById('userActive').value === 'true';

        if (!username) {
            alert('Username is required');
            return;
        }

        if (!userId && !password) {
            alert('Password is required for new users');
            return;
        }

        const userData = {
            username: username,
            email: email,
            firstName: firstName,
            lastName: lastName,
            role: role,
            active: active
        };

        if (password) {
            userData.password = password;
        }

        try {
            let response;
            if (userId) {
                // Update existing user
                response = await fetch(`/admin/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
            } else {
                // Create new user
                response = await fetch('/admin/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
            }

            if (response.ok) {
                alert(userId ? 'User updated successfully!' : 'User created successfully!');
                closeModal('userModal');
                loadUsers();
            } else {
                const error = await response.json();
                alert('Failed to save user: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error saving user:', error);
            alert('Error saving user');
        }
    }

    // Edit User
    async function editUser(id) {
        try {
            const response = await fetch('/admin/api/users');
            const users = await response.json();
            const user = users.find(u => u.id === id);

            if (!user) {
                alert('User not found');
                return;
            }

            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = user.id;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userFirstName').value = user.firstName || '';
            document.getElementById('userLastName').value = user.lastName || '';
            document.getElementById('userRole').value = user.role;
            document.getElementById('userActive').value = user.active.toString();
            document.getElementById('passwordGroup').style.display = 'none';

            openModal('userModal');
        } catch (error) {
            console.error('Error loading user:', error);
            alert('Error loading user');
        }
    }

    // Delete User
    async function deleteUser(id, username) {
        if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
            return;
        }

        try {
            const response = await fetch(`/admin/api/users/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('User deleted successfully!');
                loadUsers();
            } else {
                alert('Failed to delete user');
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Error deleting user');
        }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
</script>